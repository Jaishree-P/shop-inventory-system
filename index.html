<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop Inventory System</title>
  <style>
    :root{
      --blue:#2f78b4;
      --blue-darker:#246294;
      --muted:#f1f6fb;
      --card:#ffffff;
      --radius:10px;
      --gap:10px;
      --text-size:15px;
      --btn-height:34px;
      --view-color:#1976d2;
      --edit-color:#ff9800;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: "Poppins", sans-serif;
      margin:0;
      background-color:#f4f8fc;
      color:#222;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.3;
      -webkit-tap-highlight-color: transparent;
    }

    /* NAV */
    nav {
      background-color: var(--blue);
      color: white;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      overflow-x: auto;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 40;
    }
    nav .brand { font-weight:700; margin-right:8px; padding-right:8px; border-right:1px solid rgba(255,255,255,0.12) }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      margin: 0;
      padding: 8px 12px;
      border-radius: 8px;
      display: inline-block;
      font-size: var(--text-size);
      cursor: pointer;
    }
    nav a.active, nav a:hover { background-color: var(--blue-darker); }

    /* containers */
    .container { display: none; padding: 14px; max-width: 1100px; margin: 12px auto; }
    .active-section { display: block; }
    h2 { color: var(--blue-darker); text-align:center; margin:8px 0 18px 0; font-size:18px }

    /* tables */
    .table-wrap { width: 100%; overflow-x:auto; -webkit-overflow-scrolling: touch; }
    table {
      width: 100%;
      min-width: 760px;
      border-collapse: collapse;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      font-size: var(--text-size);
    }
    th, td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid #e9eef6;
      vertical-align: middle;
    }
    th { background: var(--muted); font-weight:700; }

    input[type="number"], select, input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #d5dce8;
      border-radius: 8px;
      outline: none;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
    }

    /* action buttons compact */
    .action-cell { display:flex; gap:8px; justify-content:center; align-items:center; }
    .btn {
      height: var(--btn-height);
      min-width: 100px;
      padding: 0 10px;
      border-radius: 8px;
      border: none;
      color: white;
      cursor: pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:13px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.transfer { background: linear-gradient(180deg,#3aa0d9,#2f78b4); }
    .btn.sell { background: linear-gradient(180deg,#4fb86b,#2fa85a); }
    .btn.danger { background:#d9534f; }
    .btn.secondary { background:#6c757d; }

    .btn.view { background: linear-gradient(180deg,var(--view-color), #145ea8); }
    .btn.view:hover { filter:brightness(.95); }
    .btn.edit { background: linear-gradient(180deg,var(--edit-color), #e88a00); }
    .btn.edit:hover { filter:brightness(.95); }

    @media (max-width:720px){
      :root{ --text-size:14px; --btn-height:36px; }
      .btn { min-width:88px; font-size:14px; }
      table { min-width:640px; }
      th,td { padding:8px 10px; }
    }
    @media (max-width:420px){
      table { min-width:600px; }
      th, td { padding:7px 8px; font-size:14px; }
    }

    /* modal */
    .modal { display:none; position:fixed; z-index:60; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:12px; }
    .modal-content { width:100%; max-width:920px; max-height:92vh; overflow:auto; background:#fff; border-radius:12px; padding:14px; }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .close-btn{ background:none; border:none; font-size:20px; cursor:pointer; }
    .total-row{ font-weight:700; background:#f1f6fb; }
    .form-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .info{ font-size:13px; color:#555; margin-top:8px; text-align:center; }

    .small-muted { font-size:13px; color:#666; }

  </style>
</head>
<body>
  <nav>
    <div class="brand">Shop Inventory</div>
    <a id="nav-mrp" class="active" onclick="showSection('mrp')">MRP Section</a>
    <a id="nav-bar" onclick="showSection('bar')">Bar Section</a>
    <a id="nav-dashboard" onclick="showSection('dashboard')">Dashboard</a>
  </nav>

  <!-- MRP -->
  <div id="mrp" class="container active-section">
    <h2>MRP Section</h2>
    <div class="table-wrap">
      <table id="mrpTable" aria-label="MRP table">
        <thead>
          <tr>
            <th>Items</th>
            <th>Opening</th>
            <th>MRP Price</th>
            <th>Bar Price</th>
            <th>Total</th>
            <th>Closing</th>
            <th>Sold (MRP)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="info">On mobile: horizontally scroll to see all columns. All inputs are numeric-only.</p>
  </div>

  <!-- Bar -->
  <div id="bar" class="container">
    <h2>Bar Section</h2>
    <div class="table-wrap">
      <table id="barTable" aria-label="Bar table">
        <thead>
          <tr>
            <th>Items</th>
            <th>Stock (Inward)</th>
            <th>Bar Price</th>
            <th>Sold (Bar)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="info">Inputs are numeric-only (mobile numeric keyboard enabled).</p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="container">
    <h2>Daily Sales Report</h2>
    <div id="dailySales" class="table-wrap"></div>
    <p class="small-muted">Each row: View (read-only), Edit (edit in modal), Close Bill (send email)</p>
  </div>

  <!-- Modal -->
  <div id="salesModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalDate">Sales Report</h3>
        <button class="close-btn" id="modalCloseBtn">&times;</button>
      </div>

      <div id="modalBody">
        <div class="table-wrap" style="margin-bottom:12px;">
          <table class="modal-table" id="modalTable" aria-label="Modal sales table">
            <thead><tr><th>Product</th><th>Section</th><th>Quantity</th><th>Price</th><th>Amount</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:8px;">
          <h4 style="margin:0 0 8px 0;">Add / Edit Sold Item for this date</h4>
          <div class="form-row">
            <select id="addProductSelect" aria-label="Select product"></select>
            <input id="addQty" type="number" inputmode="numeric" pattern="\d*" min="1" placeholder="Quantity" value="1" aria-label="Quantity" />
            <input id="addPrice" type="number" inputmode="numeric" pattern="\d*" min="0" placeholder="Amt per Quantity" value="0" aria-label="Amount per quantity" />
            <select id="addSection" aria-label="Section"><option>MRP</option><option>Bar</option></select>
            <button class="btn" id="modalAddBtn">Add</button>
          </div>
        </div>

        <div style="margin-top:12px; text-align:right;">
          <button class="btn secondary" id="modalSaveBtn">Save</button>
          <button class="btn danger" id="modalCloseBillBtn">ðŸ“¨ Close Bill</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   CONFIG
   - Uses your Render backend (HTTPS).
   - Edit API_BASE if you want to test locally.
   =========================== */
const API_BASE = (function(){
  // If running as file or on localhost, use localhost backend
  if(location.protocol === "file:" || location.hostname === "localhost" || location.hostname === "127.0.0.1") {
    return "http://localhost:5000/api";
  }
  // Production Render backend (HTTPS) - no port to prevent mixed content
  return "https://shop-inventory-system-gcil.onrender.com/api";
})();

/* ---------------------------
   Default Items & State
   --------------------------- */
const defaultItems = [
  "2 Litre Water","1 Liter water","500 ML water","soda 750ml",
  "600ml cool drinks","250ml cool drinks","5rs glass","3rs glass",
  "mixer","cover big","cover medium","cover small"
];

let mrpData = [], barData = [], dailySales = {}; // dailySales[ISO] = [{name, qty, price, section}]
let currentModalDate = null;

/* ---------------------------
   Helpers
   --------------------------- */
function toISO(dateLike){
  if(!dateLike) return new Date().toISOString().split('T')[0];
  if(typeof dateLike === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateLike)) return dateLike;
  const d = new Date(dateLike);
  if(isNaN(d)) return new Date().toISOString().split('T')[0];
  return d.toISOString().split('T')[0];
}
function isoToDisplay(iso){
  const d = new Date(iso + "T00:00:00");
  return d.toLocaleDateString();
}
function normalizeDailySales(raw){
  const out = {};
  Object.keys(raw || {}).forEach(k => { out[toISO(k)] = raw[k]; });
  return out;
}
function escapeHtml(unsafe){
  if(unsafe === null || unsafe === undefined) return "";
  return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* ---------------------------
   Local persistence
   --------------------------- */
function saveData(){
  try {
    localStorage.setItem("mrpData", JSON.stringify(mrpData));
    localStorage.setItem("barData", JSON.stringify(barData));
    localStorage.setItem("dailySales", JSON.stringify(dailySales));
  } catch(e){
    console.error("saveData error:", e);
  }
}
function loadLocalData(){
  try {
    const mrp = localStorage.getItem("mrpData");
    const bar = localStorage.getItem("barData");
    const sales = localStorage.getItem("dailySales");
    if(mrp) mrpData = JSON.parse(mrp);
    if(bar) barData = JSON.parse(bar);
    if(sales){
      try { dailySales = normalizeDailySales(JSON.parse(sales)); } catch(e){ dailySales = {}; }
    }
  } catch(e){
    console.warn("loadLocalData failed:", e);
    mrpData = []; barData = []; dailySales = {};
  }
  if(!Array.isArray(mrpData) || mrpData.length === 0) initializeItems();
}

/* ---------------------------
   Clear local storage (fresh start)
   --------------------------- */
function clearAllLocal(){
  try {
    // clear main keys
    localStorage.removeItem("mrpData");
    localStorage.removeItem("barData");
    localStorage.removeItem("dailySales");
    // clear any per-date closed flags
    Object.keys(localStorage).forEach(k=>{
      if(k && k.startsWith("billClosed_")) localStorage.removeItem(k);
    });
    // reset in-memory
    mrpData = []; barData = []; dailySales = {};
    console.log("Local data cleared for fresh start.");
  } catch(e){
    console.warn("clearAllLocal failed:", e);
  }
}

/* ---------------------------
   Backend fetch & merge
   --------------------------- */
async function fetchSalesFromBackend(){
  try {
    const res = await fetch(API_BASE + "/sales", { cache: "no-store" });
    if(!res.ok) {
      console.warn("Backend /sales returned not ok:", res.status);
      return;
    }
    const serverData = await res.json();
    // serverData is summary-form: {date: {product: {mrp, bar}, ...}, ...}
    Object.keys(serverData || {}).forEach(dateISO => {
      if(!dailySales[dateISO] || dailySales[dateISO].length === 0){
        // convert summary into entries with price=0 (we don't have price info from summary)
        const arr = [];
        const summary = serverData[dateISO] || {};
        Object.entries(summary).forEach(([product, vals]) => {
          if(vals.mrp) arr.push({ name: product, qty: Number(vals.mrp || 0), price: 0, section: "MRP" });
          if(vals.bar) arr.push({ name: product, qty: Number(vals.bar || 0), price: 0, section: "Bar" });
        });
        if(arr.length) dailySales[dateISO] = arr;
      }
    });
    renderDailySales();
    saveData();
  } catch(e){
    console.warn("fetchSalesFromBackend error:", e);
  }
}

/* ---------------------------
   Initialization
   --------------------------- */
function initializeItems(){
  mrpData = defaultItems.map(name => ({ name, opening:0, mrpPrice:0, barPrice:0, total:0, transferred:0, sales:0 }));
  barData = [];
  saveData();
}

/* ---------------------------
   UI: MRP & Bar
   --------------------------- */
function showSection(section){
  document.querySelectorAll(".container").forEach(div=>div.classList.remove("active-section"));
  const el = document.getElementById(section); if(el) el.classList.add("active-section");
  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  const map = { mrp:"nav-mrp", bar:"nav-bar", dashboard:"nav-dashboard" };
  const nav = document.getElementById(map[section]); if(nav) nav.classList.add("active");
}

function renderMRP(){
  const tbody = document.querySelector("#mrpTable tbody"); if(!tbody) return;
  tbody.innerHTML = "";
  mrpData.forEach((item,i)=>{
    item.total = Number(item.opening || 0);
    const closing = item.total - Number(item.sales || 0) - Number(item.transferred || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(item.name)}</td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.opening||0)}" onchange="updateOpening(${i}, this.value)"></td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.mrpPrice||0)}" onchange="updateMRPPrice(${i}, this.value)"></td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.barPrice||0)}" onchange="updateBarPriceInMRP(${i}, this.value)"></td>
      <td>${Number(item.total||0)}</td>
      <td>${Number(closing)}</td>
      <td>${Number(item.sales||0)}</td>
      <td><div class="action-cell">
           <button class="btn transfer" onclick="transferToBar(${i})">â‡„ Transfer</button>
           <button class="btn sell" onclick="sellFromMRP(${i})">ðŸ’² Sell</button>
         </div></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateOpening(index, val){ mrpData[index].opening = Math.max(0, parseInt(val||0)||0); saveData(); renderMRP(); }
function updateMRPPrice(index, val){ mrpData[index].mrpPrice = Math.max(0, parseFloat(val||0)||0); saveData(); renderMRP(); }
function updateBarPriceInMRP(index, val){
  mrpData[index].barPrice = Math.max(0, parseFloat(val||0)||0);
  const name = mrpData[index].name;
  const b = barData.find(x=>x.name === name);
  if(b) b.price = mrpData[index].barPrice;
  saveData(); renderMRP(); renderBar();
}

function transferToBar(index){
  const qtyStr = prompt("Enter quantity to TRANSFER to Bar (numbers only). This will be added to Bar stock (inward):");
  if(qtyStr === null) return;
  const qty = parseInt(String(qtyStr).replace(/\D/g,'')) || 0;
  if(qty <= 0) return alert("Please enter a positive number.");
  const item = mrpData[index];
  const closing = Number(item.opening || 0) - Number(item.sales || 0) - Number(item.transferred || 0);
  if(closing < qty) return alert("Not enough stock in MRP to transfer!");
  item.transferred = (item.transferred || 0) + qty;

  const price = Number(item.barPrice || item.mrpPrice || 0);
  const barItem = barData.find(b => b.name === item.name);
  if(barItem) {
    barItem.stock = (barItem.stock || 0) + qty;
    if(!barItem.price && price) barItem.price = price;
  } else {
    barData.push({ name: item.name, stock: qty, price: price, sales: 0 });
  }
  saveData(); renderMRP(); renderBar();
  alert(`Transferred ${qty} Ã— ${item.name} to Bar (inward).`);
}

function sellFromMRP(index){
  const qtyStr = prompt("Enter quantity sold at MRP price (numbers only):");
  if(qtyStr === null) return;
  const qty = parseInt(String(qtyStr).replace(/\D/g,'')) || 0;
  if(qty <= 0) return alert("Please enter a positive number.");
  const item = mrpData[index];
  const closing = Number(item.opening || 0) - Number(item.sales || 0) - Number(item.transferred || 0);
  if(closing < qty) return alert("Not enough stock in MRP to sell!");
  item.sales = (item.sales || 0) + qty;
  const price = item.mrpPrice || 0;
  logDailySale(item.name, qty, price, "MRP");
  saveData(); renderMRP(); renderBar();
  alert(`Sold ${qty} Ã— ${item.name} at MRP â‚¹${price}`);
}

function renderBar(){
  const tbody = document.querySelector("#barTable tbody"); if(!tbody) return;
  tbody.innerHTML = "";
  barData.forEach((item,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(item.name)}</td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.stock||0)}" onchange="updateBarStock(${i}, this.value)"></td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.price||0)}" onchange="updateBarPrice(${i}, this.value)"></td>
      <td>${Number(item.sales||0)}</td>
      <td><div class="action-cell"><button class="btn sell" onclick="sellFromBar(${i})">ðŸ’² Sell</button></div></td>
    `;
    tbody.appendChild(tr);
  });
}
function updateBarStock(i, val){ barData[i].stock = Math.max(0, parseInt(val||0)||0); saveData(); renderBar(); }
function updateBarPrice(i, val){ barData[i].price = Math.max(0, parseFloat(val||0)||0); saveData(); renderBar(); }

function sellFromBar(i){
  const qtyStr = prompt("Enter quantity sold at Bar price (numbers only):");
  if(qtyStr === null) return;
  const qty = parseInt(String(qtyStr).replace(/\D/g,'')) || 0;
  if(qty <= 0) return alert("Please enter a positive number.");
  const item = barData[i];
  if(item.stock < qty) return alert("Not enough stock in Bar to sell!");
  item.stock -= qty;
  item.sales = (item.sales || 0) + qty;
  const price = Number(item.price || 0);
  logDailySale(item.name, qty, price, "Bar");
  saveData(); renderBar();
  alert(`Sold ${qty} Ã— ${item.name} at Bar â‚¹${price}`);
}

/* ---------------------------
   Sales logging & backend sync
   --------------------------- */
function logDailySale(name, qty, price, section, dateISO = null){
  const iso = dateISO || toISO(new Date());
  if(!dailySales[iso]) dailySales[iso] = [];
  dailySales[iso].push({ name, qty: Number(qty||0), price: Number(price||0), section });
  saveData(); renderDailySales();
  saveSummaryToBackend(iso);
}

function saveSummaryToBackend(dateISO){
  const entries = dailySales[dateISO] || [];
  const summary = {};
  entries.forEach(s=>{
    if(!summary[s.name]) summary[s.name] = { mrp:0, bar:0 };
    const k = (s.section || "").toLowerCase();
    if(k === "mrp") summary[s.name].mrp += Number(s.qty || 0);
    else summary[s.name].bar += Number(s.qty || 0);
  });

  fetch(API_BASE + "/sales", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ date: dateISO, sales: summary })
  })
  .then(async r=>{
    if(!r.ok) {
      const txt = await r.text().catch(()=>null);
      console.warn("saveSummaryToBackend failed:", r.status, txt);
      return;
    }
    return r.json();
  })
  .then(d=>{ if(d) console.log("Saved summary to backend:", d); })
  .catch(e=>console.error("Save summary error:", e));
}

/* ---------------------------
   Dashboard rendering + modal
   --------------------------- */
function renderDailySales(){
  const div = document.getElementById("dailySales"); if(!div) return;
  div.innerHTML = "";
  const dates = Object.keys(dailySales).sort((a,b)=> b.localeCompare(a));
  if(dates.length === 0){
    div.innerHTML = "<p>No sales recorded yet.</p>";
    return;
  }
  const wrap = document.createElement("div"); wrap.style.overflowX="auto"; wrap.style.marginTop="6px";
  const table = document.createElement("table"); table.style.minWidth="760px";
  table.innerHTML = `<thead><tr><th>Date</th><th>MRP Items</th><th>Bar Items</th><th>Revenue (â‚¹)</th><th>Actions</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector("tbody");
  dates.forEach(dateISO=>{
    const entries = dailySales[dateISO] || [];
    const summary = {}; let totalAmount = 0;
    entries.forEach(s=>{
      if(!summary[s.name]) summary[s.name] = { mrp:0, bar:0, price: s.price || 0 };
      if(s.section === "MRP") summary[s.name].mrp += Number(s.qty || 0);
      else summary[s.name].bar += Number(s.qty || 0);
      summary[s.name].price = summary[s.name].price || Number(s.price || 0);
    });
    Object.keys(summary).forEach(p=>{
      const price = Number(summary[p].price || 0);
      totalAmount += (summary[p].mrp + summary[p].bar) * price;
    });
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${isoToDisplay(dateISO)}</td>
      <td>${Object.values(summary).reduce((a,c)=>a + (c.mrp||0),0)}</td>
      <td>${Object.values(summary).reduce((a,c)=>a + (c.bar||0),0)}</td>
      <td>â‚¹${Number(totalAmount||0).toFixed(2)}</td>
      <td>
        <button class="btn view" data-date="${dateISO}">View</button>
        <button class="btn edit" data-date="${dateISO}" style="margin-left:6px">Edit</button>
        <button class="btn danger" data-date="${dateISO}" style="margin-left:6px">Close Bill</button>
      </td>`;
    tbody.appendChild(tr);
  });
  wrap.appendChild(table); div.appendChild(wrap);

  // delegated handlers
  div.querySelectorAll("button.view").forEach(b=> b.addEventListener("click", e => openModal(b.dataset.date, { readonly:true })));
  div.querySelectorAll("button.edit").forEach(b=> b.addEventListener("click", e => openModal(b.dataset.date, { readonly:false })));
  div.querySelectorAll("button.danger").forEach(b=> b.addEventListener("click", e => {
    const dateISO = b.dataset.date;
    if(confirm("Send email for " + isoToDisplay(dateISO) + " ?")) closeBillFor(dateISO);
  }));
}

/* Modal */

function openModal(dateISO, opts = { readonly:false }){
  currentModalDate = dateISO;
  const modal = document.getElementById("salesModal"); if(!modal) return;
  modal.style.display = "flex";
  document.getElementById("modalDate").textContent = `Sales Report - ${isoToDisplay(dateISO)}`;
  const tbody = document.querySelector("#modalTable tbody"); tbody.innerHTML = "";

  const entries = dailySales[dateISO] || [];
  entries.forEach((s, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.idx = idx;
    tr.innerHTML = `
      <td>${escapeHtml(s.name)}</td>
      <td>${escapeHtml(s.section)}</td>
      <td><input type="number" min="0" value="${Number(s.qty||0)}" ${opts.readonly ? 'disabled' : ''} class="modal-qty"></td>
      <td><input type="number" min="0" value="${Number(s.price||0)}" ${opts.readonly ? 'disabled' : ''} class="modal-price"></td>
      <td class="modal-amount">â‚¹${((Number(s.qty||0)) * (Number(s.price||0))).toFixed(2)}</td>
      <td>${opts.readonly ? '' : '<button class="btn danger modal-remove">Remove</button>'}</td>
    `;
    tbody.appendChild(tr);
  });

  // product select
  const select = document.getElementById("addProductSelect"); select.innerHTML = "";
  const names = Array.from(new Set(defaultItems.concat(entries.map(e=>e.name))));
  names.forEach(n => { const opt = document.createElement("option"); opt.value = n; opt.textContent = n; select.appendChild(opt); });

  // set add defaults
  setModalPriceDefaults();

  // setup buttons based on readonly
  const addBtn = document.getElementById("modalAddBtn");
  const saveBtn = document.getElementById("modalSaveBtn");
  const closeBillBtn = document.getElementById("modalCloseBillBtn");
  addBtn.disabled = !!opts.readonly;
  saveBtn.disabled = !!opts.readonly;
  // show closed state if already closed
  if(localStorage.getItem(`billClosed_${dateISO}`) === "true"){
    closeBillBtn.disabled = true; closeBillBtn.textContent = "Closed";
  } else {
    closeBillBtn.disabled = false; closeBillBtn.textContent = "ðŸ“¨ Close Bill";
  }

  // live update amounts
  tbody.querySelectorAll("input.modal-qty, input.modal-price").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const row = e.target.closest("tr");
      const qty = Number(row.querySelector("input.modal-qty").value || 0);
      const price = Number(row.querySelector("input.modal-price").value || 0);
      row.querySelector(".modal-amount").textContent = "â‚¹" + (qty * price).toFixed(2);
    });
  });

  // remove handlers
  tbody.querySelectorAll("button.modal-remove").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const row = e.target.closest("tr");
      const idx = Number(row.dataset.idx);
      if(!confirm("Delete this sold item?")) return;
      dailySales[dateISO].splice(idx,1);
      saveData();
      openModal(dateISO, opts); // re-open to refresh
      renderDailySales();
    });
  });
}

function closeModal(){
  const modal = document.getElementById("salesModal"); if(modal) modal.style.display = "none";
  currentModalDate = null;
}

function setModalPriceDefaults(){
  const productEl = document.getElementById("addProductSelect");
  const sectionEl = document.getElementById("addSection");
  const priceField = document.getElementById("addPrice");
  if(!productEl || !sectionEl || !priceField) return;
  const product = productEl.value || "";
  const section = sectionEl.value || "MRP";
  // find price from mrpData/barData
  const m = mrpData.find(x=>x.name===product);
  if(section === "MRP"){
    priceField.value = m ? Number(m.mrpPrice || 0) : 0;
  } else {
    const b = barData.find(x=>x.name===product);
    priceField.value = b ? Number(b.price || 0) : (m ? Number(m.barPrice||0) : 0);
  }
}

document.getElementById("modalCloseBtn").addEventListener("click", closeModal);
document.getElementById("addProductSelect").addEventListener("change", setModalPriceDefaults);
document.getElementById("addSection").addEventListener("change", setModalPriceDefaults);

/* modal add */
document.getElementById("modalAddBtn").addEventListener("click", ()=>{
  if(!currentModalDate) return alert("Open a date first.");
  const name = document.getElementById("addProductSelect").value;
  const qty = parseInt(document.getElementById("addQty").value) || 0;
  let price = parseFloat(document.getElementById("addPrice").value) || 0;
  const section = document.getElementById("addSection").value || "MRP";
  if(!name || qty <= 0) return alert("Please enter product and numeric positive quantity.");
  if(!price){
    price = section === "MRP" ? (mrpData.find(x=>x.name===name)?.mrpPrice||0) : (barData.find(x=>x.name===name)?.price||0);
  }
  if(!dailySales[currentModalDate]) dailySales[currentModalDate] = [];
  dailySales[currentModalDate].push({ name, qty, price, section });
  saveData(); saveSummaryToBackend(currentModalDate);
  openModal(currentModalDate, { readonly:false }); renderDailySales();
  alert("Added sold item to " + isoToDisplay(currentModalDate));
});

/* modal save */
document.getElementById("modalSaveBtn").addEventListener("click", ()=>{
  if(!currentModalDate) return;
  const tbody = document.querySelector("#modalTable tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const newEntries = rows.map(row=>{
    const name = row.children[0].textContent;
    const section = row.children[1].textContent;
    const qty = Number(row.querySelector("input.modal-qty").value || 0);
    const price = Number(row.querySelector("input.modal-price").value || 0);
    return { name, qty, price, section };
  });
  dailySales[currentModalDate] = newEntries;
  saveData(); saveSummaryToBackend(currentModalDate);
  alert("Saved changes for " + isoToDisplay(currentModalDate));
  renderDailySales();
  openModal(currentModalDate, { readonly:false });
});

/* ---------------------------
   Close bill (send email)
   --------------------------- */
async function closeBillFor(dateISO){
  try {
    console.log("Requesting send-email for:", dateISO, "API_BASE=", API_BASE);
    const resp = await fetch(API_BASE + "/send-email", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ date: dateISO })
    });

    const text = await resp.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch(e){ data = { raw: text }; }

    if(!resp.ok){
      console.error("send-email failed", resp.status, resp.statusText, data);
      alert("Server returned error:\nStatus: " + resp.status + "\nBody: " + (data && data.message ? data.message : JSON.stringify(data)));
      return;
    }

    console.log("send-email success", data);
    alert((data && data.message) ? data.message : ("Email sent for " + isoToDisplay(dateISO)));
    localStorage.setItem(`billClosed_${dateISO}`, 'true');
    renderDailySales();
    if(currentModalDate === dateISO){
      const btn = document.getElementById("modalCloseBillBtn"); if(btn){ btn.disabled = true; btn.textContent = "Closed"; }
    }
  } catch (err) {
    console.error("closeBillFor error (network/exception):", err);
    alert("Failed to send email (network or exception). See console for details.\nError: " + (err && err.message ? err.message : String(err)));
  }
}
document.getElementById("modalCloseBillBtn").addEventListener("click", ()=> { if(currentModalDate) closeBillFor(currentModalDate); });

/* ---------------------------
   Init & bindings
   --------------------------- */
document.addEventListener("DOMContentLoaded", async ()=> {
  // CLEAR ALL LOCAL DATA so client starts fresh
  clearAllLocal();

  // load local (will be empty after clearAllLocal)
  loadLocalData();

  // try to merge server summaries (non-destructive) â€” optional; remove if you don't want server data
  await fetchSalesFromBackend();

  // render UI
  renderMRP(); renderBar(); renderDailySales();

  // expose some functions globally (for inline calls)
  window.showSection = showSection;
  window.transferToBar = transferToBar;
  window.sellFromMRP = sellFromMRP;
  window.sellFromBar = sellFromBar;
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.addSoldItem = ()=>{}; // not used
  window.saveModalEdits = ()=>{}; // not used
  window.closeBillFor = closeBillFor;
});
</script>
</body>
</html>
