<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop Inventory System</title>
  <style>
    :root{
      --blue:#2f78b4; --blue-darker:#246294; --muted:#f1f6fb;
      --card:#ffffff; --radius:10px; --text-size:15px; --btn-height:34px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: "Poppins", sans-serif; margin:0; background:#f4f8fc; color:#222;
    }
    nav { background:var(--blue); color:#fff; padding:10px 12px; display:flex; gap:12px; align-items:center; position:sticky; top:0; z-index:40; }
    nav .brand{font-weight:700; margin-right:8px; padding-right:8px; border-right:1px solid rgba(255,255,255,0.12)}
    nav a{ color:#fff; text-decoration:none; font-weight:600; padding:8px 12px; border-radius:8px; cursor:pointer; }
    nav a.active, nav a:hover{ background:var(--blue-darker) }

    .container{ display:none; padding:14px; max-width:1100px; margin:12px auto; }
    .active-section{ display:block; }
    h2{ color:var(--blue-darker); text-align:center; margin:8px 0 18px; font-size:18px }

    .table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch }
    table{ width:100%; min-width:760px; border-collapse:collapse; background:var(--card); border-radius:var(--radius); overflow:hidden; font-size:var(--text-size); }
    th,td{ padding:10px 12px; text-align:center; border-bottom:1px solid #e9eef6; vertical-align:middle }
    th{ background:var(--muted); font-weight:700 }

    input[type="number"], input[type="text"], select{ padding:8px 10px; border:1px solid #d5dce8; border-radius:8px; font-size:15px; width:100%; box-sizing:border-box; }

    .action-cell{ display:flex; gap:8px; justify-content:center; align-items:center }
    .btn{ height:var(--btn-height); min-width:100px; padding:0 10px; border-radius:8px; border:none; color:#fff; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; justify-content:center; gap:6px; font-size:13px }
    .btn.transfer{ background:linear-gradient(180deg,#3aa0d9,#2f78b4) }
    .btn.sell{ background:linear-gradient(180deg,#4fb86b,#2fa85a) }
    .btn.danger{ background:#d9534f }
    .btn.secondary{ background:#6c757d }
    .btn.view{ background:linear-gradient(180deg,#1976d2,#145ea8) }
    .btn.edit{ background:linear-gradient(180deg,#ff9800,#e88a00) }

    .modal{ display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; padding:12px; z-index:60 }
    .modal-content{ width:100%; max-width:920px; max-height:92vh; overflow:auto; background:#fff; border-radius:12px; padding:14px }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px }
    .close-btn{ background:none; border:none; font-size:20px; cursor:pointer }
    .total-row{ font-weight:700; background:#f1f6fb }

    .small-muted{ font-size:13px; color:#666; margin-top:8px }
    @media (max-width:720px){ table{ min-width:640px } }
  </style>
</head>
<body>
  <nav>
    <div class="brand">Shop Inventory</div>
    <a id="nav-mrp" class="active" onclick="showSection('mrp')">MRP Section</a>
    <a id="nav-bar" onclick="showSection('bar')">Bar Section</a>
    <a id="nav-dashboard" onclick="showSection('dashboard')">Dashboard</a>
  </nav>

  <!-- MRP -->
  <div id="mrp" class="container active-section">
    <h2>MRP Section</h2>
    <div class="table-wrap">
      <table id="mrpTable" aria-label="MRP table">
        <thead>
          <tr><th>Product</th><th>Opening</th><th>MRP Price</th><th>Bar Price</th><th>Total</th><th>Closing</th><th>Sold (MRP)</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="small-muted">Transfer from MRP to Bar, sell from MRP.</p>
  </div>

  <!-- Bar -->
  <div id="bar" class="container">
    <h2>Bar Section</h2>
    <div class="table-wrap">
      <table id="barTable" aria-label="Bar table">
        <thead><tr><th>Product</th><th>Stock</th><th>Bar Price</th><th>Sold (Bar)</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="small-muted">Sell from Bar or manage stock.</p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="container">
    <h2>Daily Sales Report</h2>
    <div id="dailySales" class="table-wrap"></div>
    <p class="small-muted">Click View to inspect, Edit to change, Close Bill to email.</p>
  </div>

  <!-- Modal -->
  <div id="salesModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalDate">Sales Report</h3>
        <button id="modalCloseBtn" class="close-btn">&times;</button>
      </div>

      <div id="modalBody">
        <div class="table-wrap" style="margin-bottom:12px;">
          <table id="modalTable" class="modal-table" aria-label="Modal sales table">
            <thead><tr><th>Product</th><th>Section</th><th>Quantity</th><th>Price</th><th>Amount</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:8px">
          <h4 style="margin:0 0 8px 0">Add new sold item for this date</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <select id="addProductSelect"></select>
            <select id="addSection"><option>MRP</option><option>Bar</option></select>
            <input id="addQty" type="number" min="1" value="1" placeholder="Qty" />
            <input id="addPrice" type="number" min="0" value="0" placeholder="Price" />
            <button id="modalAddBtn" class="btn">Add</button>
          </div>
        </div>

        <div style="margin-top:12px; text-align:right">
          <button id="modalSaveBtn" class="btn secondary">Save</button>
          <button id="modalCloseBillBtn" class="btn danger">ðŸ“¨ Close Bill</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   CONFIG
   --------------------------- */
// Use HTTPS Render backend in production; use localhost for local dev.
const API_BASE = (function(){
  if(location.protocol === "file:" || location.hostname === "localhost" || location.hostname === "127.0.0.1") {
    return "http://localhost:5000/api";
  }
  return "https://shop-inventory-system-gcil.onrender.com/api";
})();

/* ---------------------------
   Default items + state
   --------------------------- */
const defaultItems = [
  "2 Litre Water","1 Liter water","500 ML water","soda 750ml",
  "600ml cool drinks","250ml cool drinks","5rs glass","3rs glass",
  "mixer","cover big","cover medium","cover small"
];

let mrpData = [], barData = [], dailySales = {}; // dailySales[ISO] = [{name, qty, price, section}]
let currentModalDate = null;

/* ---------------------------
   Helpers
   --------------------------- */
function toISO(dateLike){
  if(!dateLike) return new Date().toISOString().split('T')[0];
  if(typeof dateLike === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateLike)) return dateLike;
  const d = new Date(dateLike);
  if(isNaN(d)) return new Date().toISOString().split('T')[0];
  return d.toISOString().split('T')[0];
}
function isoToDisplay(iso){
  const d = new Date(iso + "T00:00:00");
  return d.toLocaleDateString();
}
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function normalizeDailySales(raw){
  const out = {};
  Object.keys(raw || {}).forEach(k => { out[toISO(k)] = raw[k]; });
  return out;
}

/* ---------------------------
   Local storage
   --------------------------- */
function saveData(){
  try {
    localStorage.setItem("mrpData", JSON.stringify(mrpData));
    localStorage.setItem("barData", JSON.stringify(barData));
    localStorage.setItem("dailySales", JSON.stringify(dailySales));
  } catch(e){ console.error("saveData", e); }
}
function loadLocalData(){
  try {
    const mrp = localStorage.getItem("mrpData");
    const bar = localStorage.getItem("barData");
    const sales = localStorage.getItem("dailySales");
    if(mrp) mrpData = JSON.parse(mrp);
    if(bar) barData = JSON.parse(bar);
    if(sales) dailySales = normalizeDailySales(JSON.parse(sales));
  } catch(e){ console.warn("loadLocalData failed", e); mrpData=[]; barData=[]; dailySales={}; }
  if(!Array.isArray(mrpData) || mrpData.length===0) initializeItems();
}

/* ---------------------------
   Fetch server summaries (merge)
   --------------------------- */
async function fetchSalesFromBackend(){
  try {
    const res = await fetch(API_BASE + "/sales", { cache: "no-store" });
    if(!res.ok) { console.warn("/sales returned", res.status); return; }
    const serverData = await res.json();
    Object.keys(serverData || {}).forEach(dateISO => {
      if(!dailySales[dateISO] || dailySales[dateISO].length === 0){
        const arr = [];
        const summary = serverData[dateISO] || {};
        Object.entries(summary).forEach(([product, vals])=>{
          if(vals.mrp) arr.push({ name: product, qty: Number(vals.mrp||0), price: 0, section: "MRP" });
          if(vals.bar) arr.push({ name: product, qty: Number(vals.bar||0), price: 0, section: "Bar" });
        });
        if(arr.length) dailySales[dateISO] = arr;
      }
    });
    renderDailySales();
    saveData();
  } catch(e){ console.warn("fetchSalesFromBackend", e); }
}

/* ---------------------------
   Initialize items
   --------------------------- */
function initializeItems(){
  mrpData = defaultItems.map(n=>({ name:n, opening:0, mrpPrice:0, barPrice:0, total:0, transferred:0, sales:0 }));
  barData = [];
  saveData();
}

/* ---------------------------
   UI: MRP & Bar
   --------------------------- */
function showSection(section){
  document.querySelectorAll(".container").forEach(d=>d.classList.remove("active-section"));
  document.getElementById(section).classList.add("active-section");
  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  const map = { mrp:"nav-mrp", bar:"nav-bar", dashboard:"nav-dashboard" };
  const navEl = document.getElementById(map[section]); if(navEl) navEl.classList.add("active");
}

function renderMRP(){
  const tbody = document.querySelector("#mrpTable tbody"); if(!tbody) return;
  tbody.innerHTML = "";
  mrpData.forEach((item,i)=>{
    item.total = Number(item.opening||0);
    const closing = item.total - Number(item.sales||0) - Number(item.transferred||0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(item.name)}</td>
      <td><input type="number" min="0" value="${Number(item.opening||0)}" onchange="updateOpening(${i},this.value)"/></td>
      <td><input type="number" min="0" value="${Number(item.mrpPrice||0)}" onchange="updateMRPPrice(${i},this.value)"/></td>
      <td><input type="number" min="0" value="${Number(item.barPrice||0)}" onchange="updateBarPriceInMRP(${i},this.value)"/></td>
      <td>${Number(item.total||0)}</td>
      <td>${Number(closing)}</td>
      <td>${Number(item.sales||0)}</td>
      <td><div class="action-cell">
           <button class="btn transfer" onclick="transferToBar(${i})">â‡„ Transfer</button>
           <button class="btn sell" onclick="sellFromMRP(${i})">ðŸ’² Sell</button>
         </div></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateOpening(i,val){ mrpData[i].opening = Math.max(0, parseInt(val||0)||0); saveData(); renderMRP(); }
function updateMRPPrice(i,val){ mrpData[i].mrpPrice = Math.max(0, parseFloat(val||0)||0); saveData(); renderMRP(); }
function updateBarPriceInMRP(i,val){
  mrpData[i].barPrice = Math.max(0, parseFloat(val||0)||0);
  const name = mrpData[i].name;
  const b = barData.find(x=>x.name===name);
  if(b) b.price = mrpData[i].barPrice;
  saveData(); renderMRP(); renderBar();
}

function transferToBar(i){
  const qty = parseInt(prompt("Qty to transfer to Bar:")||"0") || 0;
  if(qty<=0) return alert("Invalid qty");
  const it = mrpData[i];
  const closing = Number(it.opening||0) - Number(it.sales||0) - Number(it.transferred||0);
  if(closing < qty) return alert("Not enough stock");
  it.transferred = (it.transferred||0)+qty;
  const price = Number(it.barPrice||it.mrpPrice||0);
  const b = barData.find(x=>x.name===it.name);
  if(b){ b.stock = (b.stock||0)+qty; if(!b.price && price) b.price = price; } else { barData.push({ name:it.name, stock:qty, price:price, sales:0 }); }
  saveData(); renderMRP(); renderBar();
}

function sellFromMRP(i){
  const qty = parseInt(prompt("Qty sold at MRP:")||"0") || 0;
  if(qty<=0) return alert("Invalid qty");
  const it = mrpData[i];
  const closing = Number(it.opening||0) - Number(it.sales||0) - Number(it.transferred||0);
  if(closing < qty) return alert("Not enough stock");
  it.sales = (it.sales||0) + qty;
  const price = Number(it.mrpPrice||0);
  logDailySale(it.name, qty, price, "MRP");
  saveData(); renderMRP(); renderBar();
}

function renderBar(){
  const tbody = document.querySelector("#barTable tbody"); if(!tbody) return;
  tbody.innerHTML = "";
  barData.forEach((item,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(item.name)}</td>
      <td><input type="number" min="0" value="${Number(item.stock||0)}" onchange="updateBarStock(${i},this.value)"/></td>
      <td><input type="number" min="0" value="${Number(item.price||0)}" onchange="updateBarPrice(${i},this.value)"/></td>
      <td>${Number(item.sales||0)}</td>
      <td><div class="action-cell"><button class="btn sell" onclick="sellFromBar(${i})">ðŸ’² Sell</button></div></td>
    `;
    tbody.appendChild(tr);
  });
}
function updateBarStock(i,val){ barData[i].stock = Math.max(0, parseInt(val||0)||0); saveData(); renderBar(); }
function updateBarPrice(i,val){ barData[i].price = Math.max(0, parseFloat(val||0)||0); saveData(); renderBar(); }
function sellFromBar(i){
  const qty = parseInt(prompt("Qty sold at Bar:")||"0") || 0;
  if(qty<=0) return alert("Invalid qty");
  const it = barData[i];
  if(it.stock < qty) return alert("Not enough stock");
  it.stock -= qty; it.sales = (it.sales||0) + qty;
  logDailySale(it.name, qty, Number(it.price||0), "Bar");
  saveData(); renderBar();
}

/* ---------------------------
   Sales logging & backend
   --------------------------- */
function logDailySale(name, qty, price, section, dateISO = null){
  const iso = dateISO || toISO(new Date());
  if(!dailySales[iso]) dailySales[iso] = [];
  dailySales[iso].push({ name, qty: Number(qty||0), price: Number(price||0), section });
  saveData(); renderDailySales();
  saveSummaryToBackend(iso);
}

function saveSummaryToBackend(dateISO){
  const entries = dailySales[dateISO] || [];
  const summary = {};
  entries.forEach(s=>{
    if(!summary[s.name]) summary[s.name] = { mrp:0, bar:0 };
    const k = (s.section||"").toLowerCase();
    if(k === "mrp") summary[s.name].mrp += Number(s.qty||0);
    else summary[s.name].bar += Number(s.qty||0);
  });

  fetch(API_BASE + "/sales", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ date: dateISO, sales: summary })
  })
  .then(async r=>{
    if(!r.ok){
      const txt = await r.text().catch(()=>null);
      console.warn("saveSummaryToBackend failed:", r.status, txt);
      return;
    }
    return r.json();
  })
  .then(d=>{ if(d) console.log("Saved summary to backend:", d); })
  .catch(e=>console.error("Save summary error:", e));
}

/* ---------------------------
   Dashboard & modal
   --------------------------- */
function renderDailySales(){
  const div = document.getElementById("dailySales"); if(!div) return;
  div.innerHTML = "";
  const dates = Object.keys(dailySales).sort((a,b)=> b.localeCompare(a));
  if(dates.length===0){ div.innerHTML = "<p>No sales recorded yet.</p>"; return; }

  const wrap = document.createElement("div"); wrap.style.overflowX="auto"; wrap.style.marginTop="6px";
  const table = document.createElement("table"); table.style.minWidth="760px";
  table.innerHTML = `<thead><tr><th>Date</th><th>MRP Items</th><th>Bar Items</th><th>Revenue (â‚¹)</th><th>Actions</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector("tbody");

  dates.forEach(dateISO=>{
    const entries = dailySales[dateISO] || [];
    const summary = {}; let revenue = 0;
    entries.forEach(s=>{
      if(!summary[s.name]) summary[s.name] = { mrp:0, bar:0, price: s.price || 0 };
      if(s.section === "MRP") summary[s.name].mrp += Number(s.qty||0);
      else summary[s.name].bar += Number(s.qty||0);
      summary[s.name].price = summary[s.name].price || Number(s.price||0);
    });
    Object.keys(summary).forEach(p=>{
      revenue += (summary[p].mrp + summary[p].bar) * Number(summary[p].price || 0);
    });
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${isoToDisplay(dateISO)}</td>
      <td>${Object.values(summary).reduce((a,c)=>a + (c.mrp||0),0)}</td>
      <td>${Object.values(summary).reduce((a,c)=>a + (c.bar||0),0)}</td>
      <td>â‚¹${Number(revenue||0).toFixed(2)}</td>
      <td>
        <button class="btn view" data-date="${dateISO}">View</button>
        <button class="btn edit" data-date="${dateISO}" style="margin-left:6px">Edit</button>
        <button class="btn danger" data-date="${dateISO}" style="margin-left:6px">Close Bill</button>
      </td>`;
    tbody.appendChild(tr);
  });

  wrap.appendChild(table); div.appendChild(wrap);

  // attach handlers
  div.querySelectorAll("button.view").forEach(b=>b.addEventListener("click", ()=>openModal(b.dataset.date, { readonly:true })));
  div.querySelectorAll("button.edit").forEach(b=>b.addEventListener("click", ()=>openModal(b.dataset.date, { readonly:false })));
  div.querySelectorAll("button.danger").forEach(b=>b.addEventListener("click", ()=> {
    if(confirm("Send email for " + isoToDisplay(b.dataset.date) + " ?")) closeBillFor(b.dataset.date);
  }));
}

/* Modal open/close & edit */
function openModal(dateISO, opts = { readonly:false }){
  currentModalDate = dateISO;
  const modal = document.getElementById("salesModal"); modal.style.display = "flex";
  document.getElementById("modalDate").textContent = "Sales Report - " + isoToDisplay(dateISO);
  const tbody = document.querySelector("#modalTable tbody"); tbody.innerHTML = "";

  const entries = dailySales[dateISO] ? JSON.parse(JSON.stringify(dailySales[dateISO])) : [];
  entries.forEach((e, idx)=>{
    const tr = document.createElement("tr"); tr.dataset.idx = idx;
    tr.innerHTML = `
      <td>${escapeHtml(e.name)}</td>
      <td>${escapeHtml(e.section)}</td>
      <td><input class="modal-qty" type="number" min="0" value="${Number(e.qty||0)}" ${opts.readonly ? 'disabled' : ''}></td>
      <td><input class="modal-price" type="number" min="0" value="${Number(e.price||0)}" ${opts.readonly ? 'disabled' : ''}></td>
      <td class="modal-amount">â‚¹${((Number(e.qty||0)) * (Number(e.price||0))).toFixed(2)}</td>
      <td>${opts.readonly ? '' : '<button class="btn danger modal-remove">Remove</button>'}</td>
    `;
    tbody.appendChild(tr);
  });

  // product select options
  const sel = document.getElementById("addProductSelect"); sel.innerHTML = "";
  const names = Array.from(new Set(defaultItems.concat((dailySales[dateISO]||[]).map(x=>x.name))));
  names.forEach(n => { const o = document.createElement("option"); o.value = n; o.textContent = n; sel.appendChild(o); });

  // set price default based on product & section
  document.getElementById("addSection").value = "MRP";
  setModalPriceDefaults();

  // update amount when inputs change
  tbody.querySelectorAll("input.modal-qty, input.modal-price").forEach(inp=>{
    inp.addEventListener("input", ()=> {
      const row = inp.closest("tr");
      const q = Number(row.querySelector("input.modal-qty").value||0);
      const p = Number(row.querySelector("input.modal-price").value||0);
      row.querySelector(".modal-amount").textContent = "â‚¹" + (q*p).toFixed(2);
    });
  });

  // remove handlers
  tbody.querySelectorAll("button.modal-remove").forEach(b=>{
    b.addEventListener("click", ()=>{
      if(!confirm("Delete this sold item?")) return;
      const row = b.closest("tr");
      const idx = Number(row.dataset.idx);
      dailySales[dateISO].splice(idx,1);
      saveData(); renderDailySales(); openModal(dateISO, opts);
    });
  });

  // disable add/save when readonly
  document.getElementById("modalAddBtn").disabled = !!opts.readonly;
  document.getElementById("modalSaveBtn").disabled = !!opts.readonly;

  // show closed state if already closed
  const closeBtn = document.getElementById("modalCloseBillBtn");
  if(localStorage.getItem(`billClosed_${dateISO}`) === "true"){
    closeBtn.disabled = true; closeBtn.textContent = "Closed";
  } else { closeBtn.disabled = false; closeBtn.textContent = "ðŸ“¨ Close Bill"; }
}

function closeModal(){
  document.getElementById("salesModal").style.display = "none";
  currentModalDate = null;
}

document.getElementById("modalCloseBtn").addEventListener("click", closeModal);

function setModalPriceDefaults(){
  const product = document.getElementById("addProductSelect").value;
  const section = document.getElementById("addSection").value;
  const priceInput = document.getElementById("addPrice");
  const m = mrpData.find(x=>x.name===product);
  const b = barData.find(x=>x.name===product);
  if(section === "MRP") priceInput.value = m ? Number(m.mrpPrice||0) : 0;
  else priceInput.value = b ? Number(b.price||0) : (m ? Number(m.barPrice||0) : 0);
}
document.getElementById("addProductSelect").addEventListener("change", setModalPriceDefaults);
document.getElementById("addSection").addEventListener("change", setModalPriceDefaults);

/* Add new entry in modal */
document.getElementById("modalAddBtn").addEventListener("click", ()=>{
  if(!currentModalDate) return alert("Open a date first.");
  const name = document.getElementById("addProductSelect").value;
  const qty = Math.max(0, parseInt(document.getElementById("addQty").value||0));
  let price = Math.max(0, parseFloat(document.getElementById("addPrice").value||0));
  const section = document.getElementById("addSection").value || "MRP";
  if(qty <= 0) return alert("Enter qty > 0");
  if(!dailySales[currentModalDate]) dailySales[currentModalDate] = [];
  dailySales[currentModalDate].push({ name, qty, price, section });
  saveData(); saveSummaryToBackend(currentModalDate); renderDailySales(); openModal(currentModalDate, { readonly:false });
});

/* Save edits from modal (reads input fields) */
document.getElementById("modalSaveBtn").addEventListener("click", ()=>{
  if(!currentModalDate) return;
  const rows = Array.from(document.querySelectorAll("#modalTable tbody tr"));
  const newEntries = rows.map(r=>{
    const name = r.children[0].textContent;
    const section = r.children[1].textContent;
    const qty = Math.max(0, Number(r.querySelector("input.modal-qty").value||0));
    const price = Math.max(0, Number(r.querySelector("input.modal-price").value||0));
    return { name, qty, price, section };
  });
  dailySales[currentModalDate] = newEntries;
  saveData(); saveSummaryToBackend(currentModalDate);
  alert("Saved changes for " + isoToDisplay(currentModalDate));
  renderDailySales(); openModal(currentModalDate, { readonly:false });
});

/* ---------------------------
   Close bill (send email)
   --------------------------- */
async function closeBillFor(dateISO){
  try {
    const resp = await fetch(API_BASE + "/send-email", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ date: dateISO })
    });
    const text = await resp.text();
    let data;
    try{ data = text ? JSON.parse(text) : null; } catch(e){ data = { raw:text }; }
    if(!resp.ok){
      console.error("send-email failed", resp.status, data);
      alert("Email error. See console.");
      return;
    }
    alert((data && data.message) ? data.message : ("Email sent for " + isoToDisplay(dateISO)));
    localStorage.setItem(`billClosed_${dateISO}`, "true");
    renderDailySales();
    if(currentModalDate === dateISO){
      document.getElementById("modalCloseBillBtn").disabled = true;
      document.getElementById("modalCloseBillBtn").textContent = "Closed";
    }
  } catch(err){
    console.error("closeBillFor error:", err);
    alert("Failed to send email. See console.");
  }
}
document.getElementById("modalCloseBillBtn").addEventListener("click", ()=>{ if(currentModalDate) closeBillFor(currentModalDate); });

/* ---------------------------
   Bootstrap
   --------------------------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  loadLocalData();
  await fetchSalesFromBackend();
  renderMRP(); renderBar(); renderDailySales();
  // expose functions for inline usage if needed
  window.showSection = showSection;
  window.transferToBar = transferToBar;
  window.sellFromMRP = sellFromMRP;
  window.sellFromBar = sellFromBar;
  window.openModal = openModal;
  window.closeModal = closeModal;
});
</script>
</body>
</html>
