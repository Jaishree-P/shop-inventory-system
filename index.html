<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop Inventory System</title>
  <style>
    :root{
      --blue:#2f78b4;
      --blue-darker:#246294;
      --muted:#f1f6fb;
      --card:#ffffff;
      --radius:10px;
      --gap:10px;
      --text-size:15px;
      --btn-height:34px;
      --view-color:#1976d2;
      --edit-color:#ff9800;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: "Poppins", sans-serif;
      margin:0;
      background-color:#f4f8fc;
      color:#222;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.3;
      -webkit-tap-highlight-color: transparent;
    }

    /* NAV */
    nav {
      background-color: var(--blue);
      color: white;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      overflow-x: auto;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 40;
    }
    nav .brand { font-weight:700; margin-right:8px; padding-right:8px; border-right:1px solid rgba(255,255,255,0.12) }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      margin: 0;
      padding: 8px 12px;
      border-radius: 8px;
      display: inline-block;
      font-size: var(--text-size);
      cursor: pointer;
    }
    nav a.active, nav a:hover { background-color: var(--blue-darker); }

    /* containers */
    .container { display: none; padding: 14px; max-width: 1100px; margin: 12px auto; }
    .active-section { display: block; }
    h2 { color: var(--blue-darker); text-align:center; margin:8px 0 18px 0; font-size:18px }

    /* tables */
    .table-wrap { width: 100%; overflow-x:auto; -webkit-overflow-scrolling: touch; }
    table {
      width: 100%;
      min-width: 760px;
      border-collapse: collapse;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      font-size: var(--text-size);
    }
    th, td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid #e9eef6;
      vertical-align: middle;
    }
    th { background: var(--muted); font-weight:700; }

    input[type="number"], select, input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #d5dce8;
      border-radius: 8px;
      outline: none;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
    }

    /* action buttons compact */
    .action-cell { display:flex; gap:8px; justify-content:center; align-items:center; }
    .btn {
      height: var(--btn-height);
      min-width: 100px;
      padding: 0 10px;
      border-radius: 8px;
      border: none;
      color: white;
      cursor: pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:13px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.transfer { background: linear-gradient(180deg,#3aa0d9,#2f78b4); }
    .btn.sell { background: linear-gradient(180deg,#4fb86b,#2fa85a); }
    .btn.danger { background:#d9534f; }
    .btn.secondary { background:#6c757d; }

    .btn.view { background: linear-gradient(180deg,var(--view-color), #145ea8); }
    .btn.view:hover { filter:brightness(.95); }
    .btn.edit { background: linear-gradient(180deg,var(--edit-color), #e88a00); }
    .btn.edit:hover { filter:brightness(.95); }
    .btn.undo { background: linear-gradient(180deg,#6a8,#5a7); color:#003; min-width:84px; }

    @media (max-width:720px){
      :root{ --text-size:14px; --btn-height:36px; }
      .btn { min-width:88px; font-size:14px; }
      table { min-width:640px; }
      th,td { padding:8px 10px; }
    }
    @media (max-width:420px){
      table { min-width:600px; }
      th, td { padding:7px 8px; font-size:14px; }
    }

    /* modal */
    .modal { display:none; position:fixed; z-index:60; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:12px; }
    .modal-content { width:100%; max-width:920px; max-height:92vh; overflow:auto; background:#fff; border-radius:12px; padding:14px; }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .close-btn{ background:none; border:none; font-size:20px; cursor:pointer; }
    .total-row{ font-weight:700; background:#f1f6fb; }
    .form-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .info{ font-size:13px; color:#555; margin-top:8px; text-align:center; }

    .small-muted { font-size:13px; color:#666; }

  </style>
</head>
<body>
  <nav>
    <div class="brand">Shop Inventory</div>
    <a id="nav-mrp" class="active" onclick="showSection('mrp')">MRP Section</a>
    <a id="nav-bar" onclick="showSection('bar')">Bar Section</a>
    <a id="nav-dashboard" onclick="showSection('dashboard')">Dashboard</a>
  </nav>

  <!-- MRP -->
  <div id="mrp" class="container active-section">
    <h2>MRP Section</h2>
    <div class="table-wrap">
      <table id="mrpTable" aria-label="MRP table">
        <thead>
          <tr>
            <th>Items</th>
            <th>Opening</th>
            <th>MRP Price</th>
            <th>Bar Price</th>
            <th>Total</th>
            <th>Closing</th>
            <th>Sold (MRP)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="info">On mobile: horizontally scroll to see all columns. All inputs are numeric-only.</p>
  </div>

  <!-- Bar -->
  <div id="bar" class="container">
    <h2>Bar Section</h2>
    <div class="table-wrap">
      <table id="barTable" aria-label="Bar table">
        <thead>
          <tr>
            <th>Items</th>
            <th>Stock (Inward)</th>
            <th>Bar Price</th>
            <th>Sold (Bar)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="info">Inputs are numeric-only (mobile numeric keyboard enabled).</p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="container">
    <h2>Daily Sales Report</h2>
    <div id="dailySales" class="table-wrap"></div>
    <p class="small-muted">Each row: View (read-only), Edit (edit in modal), Close Bill (send email), Undo (revert last action), Delete Day</p>
  </div>

  <!-- Modal -->
  <div id="salesModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalDate">Sales Report</h3>
        <button class="close-btn" id="modalCloseBtn">&times;</button>
      </div>

      <div id="modalBody">
        <div class="table-wrap" style="margin-bottom:12px;">
          <table class="modal-table" id="modalTable" aria-label="Modal sales table">
            <thead><tr><th>Product</th><th>Section</th><th>Quantity</th><th>Price</th><th>Amount</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:8px;">
          <h4 style="margin:0 0 8px 0;">Add / Edit Sold Item for this date</h4>
          <div class="form-row">
            <select id="addProductSelect" aria-label="Select product"></select>
            <input id="addQty" type="number" inputmode="numeric" pattern="\d*" min="1" placeholder="Quantity" value="1" aria-label="Quantity" />
            <input id="addPrice" type="number" inputmode="numeric" pattern="\d*" min="0" placeholder="Amt per Quantity" value="0" aria-label="Amount per quantity" />
            <select id="addSection" aria-label="Section"><option>MRP</option><option>Bar</option></select>
            <button class="btn" id="modalAddBtn">Add</button>
          </div>
        </div>

        <div style="margin-top:12px; text-align:right;">
          <button class="btn secondary" id="modalSaveBtn">Save</button>
          <button class="btn danger" id="modalCloseBillBtn">ðŸ“¨ Close Bill</button>
          <button class="btn undo" id="modalUndoBtn" title="Undo last action for this date">â†¶ Undo</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   CONFIG
   =========================== */
const API_BASE = (function(){
  if(location.protocol === "file:" || location.hostname === "localhost" || location.hostname === "127.0.0.1") {
    return "http://localhost:5000/api";
  }
  return "https://shop-inventory-system-gcil.onrender.com/api";
})();

/* ---------------------------
   Default Items & State
   --------------------------- */
const defaultItems = [
  "2 Litre Water","1 Liter water","500 ML water","soda 750ml",
  "600ml cool drinks","250ml cool drinks","5rs glass","3rs glass","2rs glass","chips","boti","water packet",
  "mixer","cover big","cover medium","cover small"
];

let mrpData = [], barData = [], dailySales = {}; // dailySales[ISO] = [{name, qty, price, section}]
let undoStacks = {}; // undoStacks[ISO] = [ {type, payload} ... ]
let currentModalDate = null;

/* ---------------------------
   Helpers
   --------------------------- */
function toISO(dateLike){
  if(!dateLike) return new Date().toISOString().split('T')[0];
  if(typeof dateLike === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateLike)) return dateLike;
  const d = new Date(dateLike);
  if(isNaN(d)) return new Date().toISOString().split('T')[0];
  return d.toISOString().split('T')[0];
}
function isoToDisplay(iso){
  const d = new Date(iso + "T00:00:00");
  return d.toLocaleDateString();
}
function normalizeDailySales(raw){
  const out = {};
  Object.keys(raw || {}).forEach(k => { out[toISO(k)] = raw[k]; });
  return out;
}
function escapeHtml(unsafe){
  if(unsafe === null || unsafe === undefined) return "";
  return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* ---------------------------
   Persistence (localStorage)
   --------------------------- */
function saveData(){
  try {
    localStorage.setItem("mrpData", JSON.stringify(mrpData));
    localStorage.setItem("barData", JSON.stringify(barData));
    localStorage.setItem("dailySales", JSON.stringify(dailySales));
    localStorage.setItem("undoStacks", JSON.stringify(undoStacks));
  } catch(e){
    console.error("saveData error:", e);
  }
}
function loadLocalData(){
  try {
    const mrp = localStorage.getItem("mrpData");
    const bar = localStorage.getItem("barData");
    const sales = localStorage.getItem("dailySales");
    const und = localStorage.getItem("undoStacks");
    if(mrp) mrpData = JSON.parse(mrp);
    if(bar) barData = JSON.parse(bar);
    if(sales){
      try { dailySales = normalizeDailySales(JSON.parse(sales)); } catch(e){ dailySales = {}; }
    }
    if(und) {
      try { undoStacks = JSON.parse(und) || {}; } catch(e){ undoStacks = {}; }
    }
  } catch(e){
    console.warn("loadLocalData failed:", e);
    mrpData = []; barData = []; dailySales = {}; undoStacks = {};
  }
  if(!Array.isArray(mrpData) || mrpData.length === 0) initializeItems();
}

/* ---------------------------
   Undo helpers
   --------------------------- */
function ensureUndo(dateISO){ if(!undoStacks[dateISO]) undoStacks[dateISO] = []; }
function pushUndo(dateISO, action){
  ensureUndo(dateISO);
  undoStacks[dateISO].push(action);
  saveData();
}
function popUndo(dateISO){
  ensureUndo(dateISO);
  const a = undoStacks[dateISO].pop();
  saveData();
  return a;
}
function undoAvailable(dateISO){ return Array.isArray(undoStacks[dateISO]) && undoStacks[dateISO].length > 0; }

/* Apply undo for a single date (reverses last action) */
function undoLastActionFor(dateISO){
  if(!undoAvailable(dateISO)) { alert("Nothing to undo for this date."); return; }
  const action = popUndo(dateISO);
  if(!action){ alert("Undo failed."); return; }

  // action types and reversal logic
  switch(action.type){
    case "sellMRP":{
      // payload: {mrpIndex, qty, price, barIndexOrNull, barStockBefore, dailyIndex}
      const p = action.payload;
      // revert mrp sales
      if(typeof p.mrpIndex === "number" && mrpData[p.mrpIndex]){
        mrpData[p.mrpIndex].sales = p.mrpSalesBefore;
      }
      // revert bar stock+sales
      if(typeof p.barIndex === "number" && barData[p.barIndex]){
        barData[p.barIndex].stock = p.barStockBefore;
        barData[p.barIndex].sales = p.barSalesBefore;
      }
      // remove the daily entry that was added at recorded index (or match by payload)
      if(Array.isArray(dailySales[p.date]) && typeof p.dailyIndex === "number"){
        // ensure index still in range
        if(dailySales[p.date][p.dailyIndex] && dailySales[p.date][p.dailyIndex].__undoId === p.undoId){
          dailySales[p.date].splice(p.dailyIndex,1);
        } else {
          // fallback: remove last matching entry with same undoId or name/qty/price/section
          for(let i = dailySales[p.date].length-1;i>=0;i--){
            const e = dailySales[p.date][i];
            if(e.__undoId === p.undoId || (e.name===p.name && e.qty===p.qty && e.price===p.price && e.section==='MRP')){ dailySales[p.date].splice(i,1); break; }
          }
        }
      }
      break;
    }
    case "sellBar":{
      // payload: {barIndex, qty, price, barStockBefore, barSalesBefore, dailyIndex, undoId, name, date}
      const p = action.payload;
      if(typeof p.barIndex === "number" && barData[p.barIndex]){
        barData[p.barIndex].stock = p.barStockBefore;
        barData[p.barIndex].sales = p.barSalesBefore;
      }
      if(Array.isArray(dailySales[p.date]) && typeof p.dailyIndex === "number"){
        if(dailySales[p.date][p.dailyIndex] && dailySales[p.date][p.dailyIndex].__undoId === p.undoId){
          dailySales[p.date].splice(p.dailyIndex,1);
        } else {
          for(let i = dailySales[p.date].length-1;i>=0;i--){
            const e = dailySales[p.date][i];
            if(e.__undoId === p.undoId || (e.name===p.name && e.qty===p.qty && e.price===p.price && e.section==='Bar')){ dailySales[p.date].splice(i,1); break; }
          }
        }
      }
      break;
    }
    case "transferToBar":{
      // payload: {mrpIndex, transferredBefore, barIndex, barStockBefore}
      const p = action.payload;
      if(typeof p.mrpIndex === "number" && mrpData[p.mrpIndex]){
        mrpData[p.mrpIndex].transferred = p.transferredBefore;
      }
      if(typeof p.barIndex === "number" && barData[p.barIndex]){
        barData[p.barIndex].stock = p.barStockBefore;
      } else if(p.barIndex === null){
        // it was newly created - remove it
        const idx = barData.findIndex(b => b.name === p.name);
        if(idx !== -1) barData.splice(idx,1);
      }
      break;
    }
    case "modalAdd":{
      // payload: {date, index}
      const p = action.payload;
      if(Array.isArray(dailySales[p.date])){
        dailySales[p.date].splice(p.index,1);
      }
      break;
    }
    case "modalRemove":{
      // payload: {date, index, entry}
      const p = action.payload;
      if(!Array.isArray(dailySales[p.date])) dailySales[p.date] = [];
      dailySales[p.date].splice(p.index, 0, p.entry);
      break;
    }
    case "modalSave":{
      // payload: {date, previousEntries}
      const p = action.payload;
      dailySales[p.date] = JSON.parse(JSON.stringify(p.previousEntries || []));
      break;
    }
    case "deleteDay":{
      // payload: {date, previousEntries}
      const p = action.payload;
      if(p.previousEntries) dailySales[p.date] = p.previousEntries;
      break;
    }
    default:
      console.warn("Unknown undo type:", action.type);
  }

  saveData();
  renderMRP(); renderBar(); renderDailySales();
  if(currentModalDate === dateISO) openModal(dateISO, { readonly:false });
  alert("Undo applied.");
}

/* ---------------------------
   Backend fetch & merge (non-destructive)
   --------------------------- */
async function fetchSalesFromBackend(){
  try {
    const res = await fetch(API_BASE + "/sales", { cache: "no-store" });
    if(!res.ok) { return; }
    const serverData = await res.json();
    Object.keys(serverData || {}).forEach(dateISO => {
      if(!dailySales[dateISO] || dailySales[dateISO].length === 0){
        const arr = [];
        const summary = serverData[dateISO] || {};
        Object.entries(summary).forEach(([product, vals]) => {
          if(vals.mrp) arr.push({ name: product, qty: Number(vals.mrp || 0), price: 0, section: "MRP" });
          if(vals.bar) arr.push({ name: product, qty: Number(vals.bar || 0), price: 0, section: "Bar" });
        });
        if(arr.length) dailySales[dateISO] = arr;
      }
    });
    renderDailySales();
    saveData();
  } catch(e){
    console.warn("fetchSalesFromBackend error:", e);
  }
}

/* ---------------------------
   Initialization
   --------------------------- */
function initializeItems(){
  mrpData = defaultItems.map(name => ({ name, opening:0, mrpPrice:0, barPrice:0, total:0, transferred:0, sales:0 }));
  barData = [];
  saveData();
}

/* ---------------------------
   UI: MRP & Bar
   --------------------------- */
function showSection(section){
  document.querySelectorAll(".container").forEach(div=>div.classList.remove("active-section"));
  const el = document.getElementById(section); if(el) el.classList.add("active-section");
  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  const map = { mrp:"nav-mrp", bar:"nav-bar", dashboard:"nav-dashboard" };
  const nav = document.getElementById(map[section]); if(nav) nav.classList.add("active");
}

function renderMRP(){
  const tbody = document.querySelector("#mrpTable tbody"); if(!tbody) return;
  tbody.innerHTML = "";
  mrpData.forEach((item,i)=>{
    item.total = Number(item.opening || 0);
    const closing = item.total - Number(item.sales || 0) - Number(item.transferred || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(item.name)}</td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.opening||0)}" onchange="updateOpening(${i}, this.value)"></td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.mrpPrice||0)}" onchange="updateMRPPrice(${i}, this.value)"></td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.barPrice||0)}" onchange="updateBarPriceInMRP(${i}, this.value)"></td>
      <td>${Number(item.total||0)}</td>
      <td>${Number(closing)}</td>
      <td>${Number(item.sales||0)}</td>
      <td><div class="action-cell">
           <button class="btn transfer" onclick="transferToBar(${i})">â‡„ Transfer</button>
           <button class="btn sell" onclick="sellFromMRP(${i})">ðŸ’² Sell</button>
         </div></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateOpening(index, val){ mrpData[index].opening = Math.max(0, parseInt(val||0)||0); saveData(); renderMRP(); }
function updateMRPPrice(index, val){ mrpData[index].mrpPrice = Math.max(0, parseFloat(val||0)||0); saveData(); renderMRP(); }
function updateBarPriceInMRP(index, val){
  mrpData[index].barPrice = Math.max(0, parseFloat(val||0)||0);
  const name = mrpData[index].name;
  const b = barData.find(x=>x.name === name);
  if(b) b.price = mrpData[index].barPrice;
  saveData(); renderMRP(); renderBar();
}

function transferToBar(index){
  const qtyStr = prompt("Enter quantity to TRANSFER to Bar (numbers only). This will be added to Bar stock (inward):");
  if(qtyStr === null) return;
  const qty = parseInt(String(qtyStr).replace(/\D/g,'')) || 0;
  if(qty <= 0) return alert("Please enter a positive number.");
  const item = mrpData[index];
  const closing = Number(item.opening || 0) - Number(item.sales || 0) - Number(item.transferred || 0);
  if(closing < qty) return alert("Not enough stock in MRP to transfer!");

  // prepare undo record
  const dateISO = toISO(new Date());
  const barIndex = barData.findIndex(b => b.name === item.name);
  const undoPayload = {
    mrpIndex: index,
    transferredBefore: item.transferred || 0,
    barIndex: (barIndex >= 0 ? barIndex : null),
    barStockBefore: (barIndex >= 0 ? barData[barIndex].stock : null),
    name: item.name
  };
  pushUndo(dateISO, { type: "transferToBar", payload: Object.assign({date: dateISO}, undoPayload) });

  item.transferred = (item.transferred || 0) + qty;
  const price = Number(item.barPrice || item.mrpPrice || 0);
  const barItem = barData.find(b => b.name === item.name);
  if(barItem) {
    barItem.stock = (barItem.stock || 0) + qty;
    if(!barItem.price && price) barItem.price = price;
  } else {
    barData.push({ name: item.name, stock: qty, price: price, sales: 0 });
  }
  saveData(); renderMRP(); renderBar();
  alert(`Transferred ${qty} Ã— ${item.name} to Bar (inward).`);
}

function sellFromMRP(index){
  const qtyStr = prompt("Enter quantity sold at MRP price (numbers only):");
  if(qtyStr === null) return;
  const qty = parseInt(String(qtyStr).replace(/\D/g,'')) || 0;
  if(qty <= 0) return alert("Please enter a positive number.");
  const item = mrpData[index];
  const closing = Number(item.opening || 0) - Number(item.sales || 0) - Number(item.transferred || 0);
  if(closing < qty) return alert("Not enough stock in MRP to sell!");

  // capture pre-state for undo
  const dateISO = toISO(new Date());
  const barIndex = barData.findIndex(b => b.name === item.name);
  const barStockBefore = (barIndex>=0 ? barData[barIndex].stock : null);
  const barSalesBefore = (barIndex>=0 ? barData[barIndex].sales : null);
  const mrpSalesBefore = item.sales || 0;

  // create a unique undo id so we can match entry later
  const undoId = "u_"+Date.now()+"_"+Math.floor(Math.random()*9999);
  const dailyIndex = (dailySales[dateISO]||[]).length;

  // push undo BEFORE mutating
  pushUndo(dateISO, {
    type: "sellMRP",
    payload: {
      date: dateISO,
      mrpIndex: index,
      mrpSalesBefore,
      barIndex: (barIndex>=0 ? barIndex : null),
      barStockBefore,
      barSalesBefore,
      dailyIndex,
      qty,
      price: item.mrpPrice || 0,
      name: item.name,
      undoId
    }
  });

  // mutate state
  item.sales = (item.sales || 0) + qty;
  // move into bar stock (sell from mrp doesn't always add to bar - original logic added)
  // (we won't change bar.stock here; original flow added to bar only on transfer)
  // Add entry to dailySales with __undoId so undo can find exact entry
  if(!dailySales[dateISO]) dailySales[dateISO] = [];
  dailySales[dateISO].push({ name: item.name, qty, price: item.mrpPrice || 0, section: "MRP", __undoId: undoId });

  saveData(); renderMRP(); renderBar(); renderDailySales();
  alert(`Sold ${qty} Ã— ${item.name} at MRP â‚¹${item.mrpPrice || 0}`);
}

function renderBar(){
  const tbody = document.querySelector("#barTable tbody"); if(!tbody) return;
  tbody.innerHTML = "";
  barData.forEach((item,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(item.name)}</td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.stock||0)}" onchange="updateBarStock(${i}, this.value)"></td>
      <td><input type="number" inputmode="numeric" min="0" value="${Number(item.price||0)}" onchange="updateBarPrice(${i}, this.value)"></td>
      <td>${Number(item.sales||0)}</td>
      <td><div class="action-cell"><button class="btn sell" onclick="sellFromBar(${i})">ðŸ’² Sell</button></div></td>
    `;
    tbody.appendChild(tr);
  });
}
function updateBarStock(i, val){ barData[i].stock = Math.max(0, parseInt(val||0)||0); saveData(); renderBar(); }
function updateBarPrice(i, val){ barData[i].price = Math.max(0, parseFloat(val||0)||0); saveData(); renderBar(); }

function sellFromBar(i){
  const qtyStr = prompt("Enter quantity sold at Bar price (numbers only):");
  if(qtyStr === null) return;
  const qty = parseInt(String(qtyStr).replace(/\D/g,'')) || 0;
  if(qty <= 0) return alert("Please enter a positive number.");
  const item = barData[i];
  if(item.stock < qty) return alert("Not enough stock in Bar to sell!");

  // prepare undo payload
  const dateISO = toISO(new Date());
  const barStockBefore = item.stock;
  const barSalesBefore = item.sales || 0;
  const dailyIndex = (dailySales[dateISO]||[]).length;
  const undoId = "u_"+Date.now()+"_"+Math.floor(Math.random()*9999);

  pushUndo(dateISO, {
    type: "sellBar",
    payload: {
      date: dateISO,
      barIndex: i,
      barStockBefore,
      barSalesBefore,
      dailyIndex,
      qty,
      price: item.price || 0,
      name: item.name,
      undoId
    }
  });

  item.stock -= qty;
  item.sales = (item.sales || 0) + qty;
  if(!dailySales[dateISO]) dailySales[dateISO] = [];
  dailySales[dateISO].push({ name: item.name, qty, price: item.price || 0, section: "Bar", __undoId: undoId });

  saveData(); renderBar(); renderDailySales();
  alert(`Sold ${qty} Ã— ${item.name} at Bar â‚¹${item.price || 0}`);
}

/* ---------------------------
   Sales logging helpers (modal / manual)
   --------------------------- */
function logDailySale(name, qty, price, section, dateISO = null){
  const iso = dateISO || toISO(new Date());
  if(!dailySales[iso]) dailySales[iso] = [];
  const undoId = "u_"+Date.now()+"_"+Math.floor(Math.random()*9999);
  dailySales[iso].push({ name, qty: Number(qty||0), price: Number(price||0), section, __undoId: undoId });
  // push undo for modal-add style
  pushUndo(iso, { type: "modalAdd", payload: { date: iso, index: dailySales[iso].length-1 } });
  saveData(); renderDailySales();
  saveSummaryToBackend(iso);
}

/* ---------------------------
   Save summary to backend (same as before, non-blocking)
   --------------------------- */
function saveSummaryToBackend(dateISO){
  const entries = dailySales[dateISO] || [];
  const summary = {};
  entries.forEach(s=>{
    if(!summary[s.name]) summary[s.name] = { mrp:0, bar:0 };
    const k = (s.section || "").toLowerCase();
    if(k === "mrp") summary[s.name].mrp += Number(s.qty || 0);
    else summary[s.name].bar += Number(s.qty || 0);
  });

  fetch(API_BASE + "/sales", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ date: dateISO, sales: summary })
  }).then(async r=>{
    if(!r.ok){
      const txt = await r.text().catch(()=>null);
      console.warn("saveSummaryToBackend failed:", r.status, txt);
      return;
    }
    return r.json();
  }).then(d=>{ if(d) console.log("Saved summary to backend:", d); })
  .catch(e=>console.error("Save summary error:", e));
}

/* ---------------------------
   Dashboard rendering + modal handling
   --------------------------- */
function renderDailySales(){
  const div = document.getElementById("dailySales"); if(!div) return;
  div.innerHTML = "";
  const dates = Object.keys(dailySales).sort((a,b)=> b.localeCompare(a));
  if(dates.length === 0){
    div.innerHTML = "<p>No sales recorded yet.</p>";
    return;
  }
  const wrap = document.createElement("div"); wrap.style.overflowX="auto"; wrap.style.marginTop="6px";
  const table = document.createElement("table"); table.style.minWidth="760px";
  table.innerHTML = `<thead><tr><th>Date</th><th>MRP Items</th><th>Bar Items</th><th>Revenue (â‚¹)</th><th>Actions</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector("tbody");
  dates.forEach(dateISO=>{
    const entries = dailySales[dateISO] || [];
    const summary = {}; let totalAmount = 0;
    entries.forEach(s=>{
      if(!summary[s.name]) summary[s.name] = { mrp:0, bar:0, price: s.price || 0 };
      if(s.section === "MRP") summary[s.name].mrp += Number(s.qty || 0);
      else summary[s.name].bar += Number(s.qty || 0);
      summary[s.name].price = summary[s.name].price || Number(s.price || 0);
    });
    Object.keys(summary).forEach(p=>{
      const price = Number(summary[p].price || 0);
      totalAmount += (summary[p].mrp + summary[p].bar) * price;
    });
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${isoToDisplay(dateISO)}</td>
      <td>${Object.values(summary).reduce((a,c)=>a + (c.mrp||0),0)}</td>
      <td>${Object.values(summary).reduce((a,c)=>a + (c.bar||0),0)}</td>
      <td>â‚¹${Number(totalAmount||0).toFixed(2)}</td>
      <td>
        <button class="btn view" data-date="${dateISO}">View</button>
        <button class="btn edit" data-date="${dateISO}" style="margin-left:6px">Edit</button>
        <button class="btn danger" data-date="${dateISO}" style="margin-left:6px">Close Bill</button>
        <button class="btn undo" data-date="${dateISO}" style="margin-left:6px">Undo</button>
        <button class="btn secondary" data-date="${dateISO}" style="margin-left:6px">Delete Day</button>
      </td>`;
    tbody.appendChild(tr);
  });
  wrap.appendChild(table); div.appendChild(wrap);

  // attach handlers
  div.querySelectorAll("button.view").forEach(b=>b.addEventListener("click", ()=>openModal(b.dataset.date, { readonly:true })));
  div.querySelectorAll("button.edit").forEach(b=>b.addEventListener("click", ()=>openModal(b.dataset.date, { readonly:false })));
  div.querySelectorAll("button.danger").forEach(b=>b.addEventListener("click", ()=> {
    const dateISO = b.dataset.date;
    if(confirm("Send email for " + isoToDisplay(dateISO) + " ?")) closeBillFor(dateISO);
  }));
  div.querySelectorAll("button.undo").forEach(b=>b.addEventListener("click", ()=> {
    const dateISO = b.dataset.date;
    if(!undoAvailable(dateISO)) return alert("No undo available for this date.");
    if(confirm("Undo last action for " + isoToDisplay(dateISO) + " ?")) {
      undoLastActionFor(dateISO);
    }
  }));
  div.querySelectorAll("button.secondary").forEach(b=>b.addEventListener("click", ()=> {
    const dateISO = b.dataset.date;
    if(!confirm("Delete entire day's data for " + isoToDisplay(dateISO) + " ? This cannot be undone (unless you use undo immediately).")) return;
    // push undo that can restore day (so it's undoable)
    const prev = JSON.parse(JSON.stringify(dailySales[dateISO] || []));
    pushUndo(dateISO, { type: "deleteDay", payload: { date: dateISO, previousEntries: prev } });
    delete dailySales[dateISO];
    // also remove any billClosed flag
    localStorage.removeItem(`billClosed_${dateISO}`);
    saveData();
    renderDailySales();
    alert("Deleted day: " + isoToDisplay(dateISO) + ". You can undo using the Undo button for that date.");
  }));
}

/* Modal open/close & edit */
function openModal(dateISO, opts = { readonly:false }){
  currentModalDate = dateISO;
  const modal = document.getElementById("salesModal"); modal.style.display = "flex";
  document.getElementById("modalDate").textContent = "Sales Report - " + isoToDisplay(dateISO);
  const tbody = document.querySelector("#modalTable tbody"); tbody.innerHTML = "";

  if(!dailySales[dateISO]) dailySales[dateISO] = [];

  const entries = dailySales[dateISO];
  entries.forEach((e, idx) => {
    const tr = document.createElement("tr"); tr.dataset.idx = idx;
    tr.innerHTML = `
      <td>${escapeHtml(e.name)}</td>
      <td>${escapeHtml(e.section)}</td>
      <td><input class="modal-qty" type="number" min="0" value="${Number(e.qty||0)}" ${opts.readonly ? 'disabled' : ''}></td>
      <td><input class="modal-price" type="number" min="0" value="${Number(e.price||0)}" ${opts.readonly ? 'disabled' : ''}></td>
      <td class="modal-amount">â‚¹${((Number(e.qty||0)) * (Number(e.price||0))).toFixed(2)}</td>
      <td>${opts.readonly ? '' : '<button class="btn danger modal-remove">Remove</button>'}</td>
    `;
    tbody.appendChild(tr);
  });

  // product select
  const select = document.getElementById("addProductSelect"); select.innerHTML = "";
  const names = Array.from(new Set(defaultItems.concat(entries.map(x=>x.name))));
  names.forEach(n => { const opt = document.createElement("option"); opt.value = n; opt.textContent = n; select.appendChild(opt); });

  // set add defaults
  setModalPriceDefaults();

  // setup buttons
  const addBtn = document.getElementById("modalAddBtn");
  const saveBtn = document.getElementById("modalSaveBtn");
  const closeBillBtn = document.getElementById("modalCloseBillBtn");
  const undoBtn = document.getElementById("modalUndoBtn");

  addBtn.disabled = !!opts.readonly;
  saveBtn.disabled = !!opts.readonly;
  undoBtn.disabled = !undoAvailable(dateISO);

  // live update amounts
  tbody.querySelectorAll("input.modal-qty, input.modal-price").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const row = e.target.closest("tr");
      const qty = Number(row.querySelector("input.modal-qty").value || 0);
      const price = Number(row.querySelector("input.modal-price").value || 0);
      row.querySelector(".modal-amount").textContent = "â‚¹" + (qty * price).toFixed(2);
    });
  });

  // remove handlers
  tbody.querySelectorAll("button.modal-remove").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const row = e.target.closest("tr");
      const idx = Number(row.dataset.idx);
      if(!confirm("Delete this sold item?")) return;
      // push undo remove (so we can re-insert)
      const entry = dailySales[dateISO][idx];
      pushUndo(dateISO, { type: "modalRemove", payload: { date: dateISO, index: idx, entry: JSON.parse(JSON.stringify(entry)) } });

      dailySales[dateISO].splice(idx,1);
      saveData();
      openModal(dateISO, opts); // refresh
      renderDailySales();
    });
  });
}

function closeModal(){
  const modal = document.getElementById("salesModal"); if(modal) modal.style.display = "none";
  currentModalDate = null;
}
document.getElementById("modalCloseBtn").addEventListener("click", closeModal);

function setModalPriceDefaults(){
  const productEl = document.getElementById("addProductSelect");
  const sectionEl = document.getElementById("addSection");
  const priceField = document.getElementById("addPrice");
  if(!productEl || !sectionEl || !priceField) return;
  const product = productEl.value || "";
  const section = sectionEl.value || "MRP";
  const m = mrpData.find(x=>x.name===product);
  if(section === "MRP"){
    priceField.value = m ? Number(m.mrpPrice || 0) : 0;
  } else {
    const b = barData.find(x=>x.name===product);
    priceField.value = b ? Number(b.price || 0) : (m ? Number(m.barPrice||0) : 0);
  }
}
document.getElementById("addProductSelect").addEventListener("change", setModalPriceDefaults);
document.getElementById("addSection").addEventListener("change", setModalPriceDefaults);

/* modal add */
document.getElementById("modalAddBtn").addEventListener("click", ()=>{
  if(!currentModalDate) return alert("Open a date first.");
  const name = document.getElementById("addProductSelect").value;
  const qty = parseInt(document.getElementById("addQty").value) || 0;
  let price = parseFloat(document.getElementById("addPrice").value) || 0;
  const section = document.getElementById("addSection").value || "MRP";
  if(!name || qty <= 0) return alert("Please enter product and numeric positive quantity.");
  if(!price){
    price = section === "MRP" ? (mrpData.find(x=>x.name===name)?.mrpPrice||0) : (barData.find(x=>x.name===name)?.price||0);
  }
  if(!dailySales[currentModalDate]) dailySales[currentModalDate] = [];

  // push undo for this add
  const idx = dailySales[currentModalDate].length;
  dailySales[currentModalDate].push({ name, qty, price, section });
  pushUndo(currentModalDate, { type: "modalAdd", payload: { date: currentModalDate, index: idx } });

  saveData(); saveSummaryToBackend(currentModalDate);
  openModal(currentModalDate, { readonly:false }); renderDailySales();
});

/* modal save (edits entire day's entries) */
document.getElementById("modalSaveBtn").addEventListener("click", ()=>{
  if(!currentModalDate) return;
  const tbody = document.querySelector("#modalTable tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  // capture previous entries for undo
  const previousEntries = JSON.parse(JSON.stringify(dailySales[currentModalDate] || []));
  const newEntries = rows.map(row=>{
    const name = row.children[0].textContent;
    const section = row.children[1].textContent;
    const qty = Number(row.querySelector("input.modal-qty").value || 0);
    const price = Number(row.querySelector("input.modal-price").value || 0);
    return { name, qty, price, section };
  });
  // push undo as modalSave to restore previousEntries if needed
  pushUndo(currentModalDate, { type: "modalSave", payload: { date: currentModalDate, previousEntries } });
  dailySales[currentModalDate] = newEntries;
  saveData(); saveSummaryToBackend(currentModalDate);
  alert("Saved changes for " + isoToDisplay(currentModalDate));
  renderDailySales();
  openModal(currentModalDate, { readonly:false });
});

/* modal undo button */
document.getElementById("modalUndoBtn").addEventListener("click", ()=>{
  if(!currentModalDate) return alert("Open a date first.");
  if(!undoAvailable(currentModalDate)) return alert("No undo available for this date.");
  if(confirm("Undo last action for " + isoToDisplay(currentModalDate) + " ?")) {
    undoLastActionFor(currentModalDate);
  }
});

/* ---------------------------
   Close bill (send email) â€” keep editable after send
   --------------------------- */
async function closeBillFor(dateISO){
  try {
    const resp = await fetch(API_BASE + "/send-email", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ date: dateISO })
    });
    const text = await resp.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch(e){ data = { raw:text }; }
    if(!resp.ok){
      console.error("send-email failed", resp.status, resp.statusText, data);
      alert("Server returned error (see console).");
      return;
    }
    // we DO NOT lock the day; just store that we sent an email (optional)
    const countKey = `emailSentCount_${dateISO}`;
    const prev = parseInt(localStorage.getItem(countKey)||"0",10) || 0;
    localStorage.setItem(countKey, String(prev+1));
    alert((data && data.message) ? data.message : ("Email sent for " + isoToDisplay(dateISO)));
    renderDailySales();
    // refresh modal button state if open
    if(currentModalDate === dateISO){
      const cb = document.getElementById("modalCloseBillBtn"); if(cb) cb.textContent = "ðŸ“¨ Sent";
    }
  } catch (err) {
    console.error("closeBillFor error (network/exception):", err);
    alert("Failed to send email (network or exception). See console for details.");
  }
}
document.getElementById("modalCloseBillBtn").addEventListener("click", ()=> { if(currentModalDate) closeBillFor(currentModalDate); });

/* ---------------------------
   Init & bindings
   --------------------------- */
/* ---------------------------
   Init & bindings
   --------------------------- */
document.addEventListener("DOMContentLoaded", async ()=> {

  // DO NOT CLEAR LOCAL DATA
  // (so client can continue using stored values)
  // clearAllLocal();

  // Load local data ONLY (MRP, Bar, Dashboard)
  loadLocalData();

  // âŒ IMPORTANT: Do NOT load backend data â€” prevents restoring deleted days
  // await fetchSalesFromBackend();

  // Now render the UI
  renderMRP();
  renderBar();
  renderDailySales();

  // expose global functions
  window.showSection = showSection;
  window.transferToBar = transferToBar;
  window.sellFromMRP = sellFromMRP;
  window.sellFromBar = sellFromBar;
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.addSoldItem = ()=>{}; 
  window.saveModalEdits = ()=>{}; 
  window.closeBillFor = closeBillFor;
});

</script>
</body>
</html>
